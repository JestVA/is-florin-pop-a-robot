<!DOCTYPE html>
<html lang="en" prefix="og: https://ogp.me/ns#">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta http-equiv="X-UA-Compatible" content="ie=edge">
		<title>ü§ñ Is Florin Pop A Robot? Beep Beep</title>
		<link href="https://fonts.googleapis.com/css?family=Lato:300,400" rel="stylesheet">
		<link href="./style.css" rel="stylesheet">
		<script type="text/javascript" src="config.js"></script>
		<script type="text/javascript" src="findYTvideos.js"></script>
		<script type="text/javascript" src="./interactive.js"></script>
	</head>

	<body>
		<!-- shiny button that spills out the facts  -->
		<h1>This Button Does Nothing.. or Everything</h1>
		<button class="btn" onclick="findAnswer()">I want to know! ü§∑‚Äç‚ôÇÔ∏è</button>
		<div id="answer"></div>
	</body>

	<script type="text/javascript">
		
		const answerDOMElement = document.getElementById('answer');

		async function findAnswer()
		{
			// reset log if exists
			resetAnswerDiv(answerDOMElement);
			
			let quotaLimit,
				nextPageToken;
			
			const videoIds = [];

			const res = await getVideoIdsWithPagination(config);

			// check quota now
			quotaLimit = deterMineQuotaErrorAndShowWarning(res);

			if(quotaLimit)
				return;

			nextPageToken = res.nextPageToken;
		
			videoIds.push(extractIdCollection(res.items));

			while(nextPageToken && ! quotaLimit)
			{ 
				const nextPageResults = await getVideoIdsWithPagination(config, nextPageToken);

				// will break out of loop if any errors while doing pages
				quotaLimit = deterMineQuotaErrorAndShowWarning(nextPageResults);

				videoIds.push(extractIdCollection(nextPageResults.items));

				nextPageToken = nextPageResults.nextPageToken || null; // Obj Key missing when no next page
			};

			// we have all the video ids at this stage, since begining of channel
			// loop through array and do call to get duration
			
			let durationTally = 0;

			if(quotaLimit) // we need this here due to control flow after while loop
				return;

			// quick and dirty
			for(let i = 0; i < videoIds.length; i++)
			{
				// fetches up to 50 vids at once
				const query = makeVideoIdQueryString(videoIds[i], config);

				// got lazy and made this a triadic f. bad bad bad - who likes Bolognese?!
				const { items } = await getVideoIdsWithPagination(false, false, query);

				durationTally += items.reduce((a, c) => a += parseDurationString(c.contentDetails.duration), 0);
			};

			// This is YT for now, need to get Twitter as well
			return durationTally;
		}



		// used when API rate limit is hit (currently 10.000 credits/day, 1 request cca 10-100 credits?)
		function deterMineQuotaErrorAndShowWarning(respType)
		{
			if(respType.error.message)
			{
				appendTextNodesToAnswer(answerDOMElement, "ü§ñ: Sorry traveller, my API Quota for today was consumed", true);
				return true;
			}
			return false;
		}

		function extractIdCollection(results = [])
		{
			return results.filter(i => i.id.videoId).map(vid => vid.id.videoId);
		}

		function makeVideoIdQueryString(ids = [])
		{
			// joins up to 50 video ids in a string
			const url = `https://www.googleapis.com/youtube/v3/videos?id=${ids.join(',')}&part=contentDetails&key=${config.API_KEY}`
			return url;
		}

		// good when ppl will test this and click the button several times
		// don't want to make a fool of myself haha
		function resetAnswerDiv(element)
		{
			element.innerHTML = "";
		}


		function appendTextNodesToAnswer(node, text, error = false)
		{
			if(error)
				node.innerHTML = "";
			
			const p = document.createElement("p");
			const t = document.createTextNode(text);
			p.appendChild(t);
			node.appendChild(p);
			node.className = "show";
		}

		/* https://stackoverflow.com/questions/14934089/convert-iso-8601-duration-with-javascript/29153059 */
		function parseDurationString( durationString ){
			const stringPattern = /^PT(?:(\d+)D)?(?:(\d+)H)?(?:(\d+)M)?(?:(\d+(?:\.\d{1,3})?)S)?$/;
			const stringParts = stringPattern.exec( durationString );
			return (
					(
					(
						( stringParts[1] === undefined ? 0 : stringParts[1]*1 )  /* Days */
						* 24 + ( stringParts[2] === undefined ? 0 : stringParts[2]*1 ) /* Hours */
					)
					* 60 + ( stringParts[3] === undefined ? 0 : stringParts[3]*1 ) /* Minutes */
					)
					* 60 + ( stringParts[4] === undefined ? 0 : stringParts[4]*1 ) /* Seconds */
				);
		}
	</script>
</html>
