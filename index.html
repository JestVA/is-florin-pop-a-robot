<!DOCTYPE html>
<html lang="en" prefix="og: https://ogp.me/ns#">
	<head>
		<meta charset="utf-8">
		<title>ü§ñ Is Florin Pop A Robot? Beep Beep</title>
		<link href="https://fonts.googleapis.com/css?family=Lato:300,400" rel="stylesheet">
		<link href="./style.css" rel="stylesheet">
		<script type="text/javascript" src="config.js"></script>
		<script type="text/javascript" src="findYTvideos.js"></script>
		<script type="text/javascript" src="./interactive.js"></script>
	</head>

	<body>
		<!-- shiny button that spills out the facts  -->
		<h1>This Button Does Nothing.. or Everything</h1>
		<button class="btn" onclick="findAnswer()">I want to know! ü§∑‚Äç‚ôÇÔ∏è</button>
		<div id="answer"></div>
	</body>

	<script type="text/javascript">
		
		async function findAnswer()
		{
			resetAnswerDiv(document.getElementById('answer'));
			appendTextNodesToAnswer(document.getElementById('answer'), "ü§ñ: Sorry traveller, my API Quota for today was consumed", true);
			
			const videoIds = [];

			let noQuotaLimit = true;
			
			let nextPageToken = null;

			const res = await getVideoIdsWithPagination(config);

			// quota might be done for the day

			// console.log(res)
			noQuotaLimit = ! deterMineQuotaErrorAndShowWarning(res);

			nextPageToken = res.nextPageToken;
		
			videoIds.push(extractIdCollection(res.items));

			while(nextPageToken && noQuotaLimit)
			{ 
				const nextPageResults = await getVideoIdsWithPagination(config, nextPageToken);

				// same here 

				noQuotaLimit = ! deterMineQuotaErrorAndShowWarning(nextPageResults);
					
				// console.log(nextPageResults);

				videoIds.push(extractIdCollection(nextPageResults.items));
				nextPageToken = nextPageResults.nextPageToken || null;
			}

			// we have all the ids at this stage
			// an array of arrays 
			// loop through array and do api call to get duration 
			let durationTally = 0;

			console.log(noQuotaLimit);

			if(noQuotaLimit === false)
				return; // paint something in the DOM;

			for(let i = 0; i < videoIds.length; i++)
			{
				// fetches up to 50 vids at once
				const query = makeVideoIdQueryString(videoIds[i], config);

				// got lazy and made this a triadic f. bad bad bad
				const { items } = await getVideoIdsWithPagination(false, false, query);

				durationTally += items.reduce((a, c) => a+= parseDurationString(c.contentDetails.duration), 0);
			}

			// This is YT for now, need to get Twitter as well

			return durationTally;
		}

		function deterMineQuotaErrorAndShowWarning(respType)
		{
			console.log(respType.error.message);
			if(respType.error.message)
				return true;
			else
				return false;
		}

		function extractIdCollection(results = [])
		{
			return results.filter(i => i.id.videoId).map(vid => vid.id.videoId);
		}

		function makeVideoIdQueryString(ids = [])
		{
			const url = `https://www.googleapis.com/youtube/v3/videos?id=${ids.join(',')}&part=contentDetails&key=${config.API_KEY}`
			return url;
		}

		function resetAnswerDiv(element)
		{
			element.innerHTML = "";
			element.className = "show";
		}

		function appendTextNodesToAnswer(node, text, error = false)
		{
			if(error)
				node.innerHTML = "";
			
			const p = document.createElement("p");
			const t = document.createTextNode(text);
			p.appendChild(t);
			node.appendChild(p);
		}

		/* https://stackoverflow.com/questions/14934089/convert-iso-8601-duration-with-javascript/29153059 */
		function parseDurationString( durationString ){
			const stringPattern = /^PT(?:(\d+)D)?(?:(\d+)H)?(?:(\d+)M)?(?:(\d+(?:\.\d{1,3})?)S)?$/;
			const stringParts = stringPattern.exec( durationString );
			return (
					(
					(
						( stringParts[1] === undefined ? 0 : stringParts[1]*1 )  /* Days */
						* 24 + ( stringParts[2] === undefined ? 0 : stringParts[2]*1 ) /* Hours */
					)
					* 60 + ( stringParts[3] === undefined ? 0 : stringParts[3]*1 ) /* Minutes */
					)
					* 60 + ( stringParts[4] === undefined ? 0 : stringParts[4]*1 ) /* Seconds */
				);
		}
	</script>
</html>
